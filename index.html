<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¸”ë¡œê·¸ ìƒ‰ì¸ ê²€ìƒ‰ ë“±ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="bg-gradient-to-b from-blue-500 to-blue-700 text-white font-sans">

  <!-- ë¡œê·¸ì¸ ì•ˆë‚´ -->
  <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center">
    <h1 class="text-3xl font-bold mb-6">ğŸ”’ ë¡œê·¸ì¸ í•„ìš”</h1>
    <p class="mb-4 text-lg">ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.</p>
    <button onclick="netlifyIdentity.open()" class="bg-white text-blue-800 px-6 py-2 rounded shadow font-semibold">
      ë¡œê·¸ì¸ / íšŒì›ê°€ì…
    </button>
  </div>

  <!-- ì•± ë³¸ë¬¸ -->
  <section id="appSection" class="hidden min-h-screen flex flex-col items-center justify-start px-4 pt-10">
    <div class="flex space-x-4 mb-6">
      <button id="tabSearch" class="px-4 py-2 bg-white text-blue-700 rounded font-semibold hover:bg-gray-200">ğŸ” ìƒ‰ì¸ ë“±ë¡</button>
      <button id="tabStats" class="px-4 py-2 bg-blue-100 text-blue-800 rounded font-semibold hover:bg-gray-200">ğŸ“Š í†µê³„ ë³´ê¸°</button>
    </div>

    <!-- ìƒ‰ì¸ ë“±ë¡ -->
    <div id="searchView" class="w-full flex flex-col items-center">
      <form id="submitForm" class="w-full max-w-xl flex relative">
        <input 
          type="text" 
          id="blogUrl" 
          placeholder="ë¸”ë¡œê·¸ ì£¼ì†Œ ì…ë ¥ (ì˜ˆ: myblog.tistory.com)" 
          class="flex-1 h-14 px-4 text-black rounded-l-md focus:outline-none text-lg" 
          required
        />
        <button 
          type="submit" 
          class="bg-white text-blue-700 px-6 rounded-r-md text-lg font-semibold hover:bg-gray-200 transition-colors"
        >
          í™•ì¸í•˜ê¸°
        </button>
      </form>

      <button 
        id="indexSubmitBtn" 
        class="mt-4 bg-green-500 text-white px-6 py-2 rounded font-semibold hover:bg-green-600 transition-colors disabled:opacity-50"
        disabled
      >
        ìƒ‰ì¸ ë“±ë¡ ìš”ì²­
      </button>

      <div id="resultBox" class="hidden mt-10 bg-white text-black rounded-md p-6 shadow-md w-full max-w-xl">
        <h2 class="text-xl font-bold mb-2">âœ… ê²°ê³¼</h2>
        <p id="resultText" class="text-gray-800 whitespace-pre-line">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
      </div>
    </div>

    <!-- í†µê³„ -->
    <div id="statsView" class="hidden w-full max-w-2xl bg-white text-black rounded-md shadow-md p-6">
      <h2 class="text-2xl font-bold mb-4">ğŸ“Š ì˜¤ëŠ˜ í†µê³„</h2>
      <div id="statsContent">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </section>

  <footer id="footer" class="hidden bg-white text-gray-800 text-center py-10">
    <p class="text-lg font-semibold">ëˆ„ë½ëœ ê¸€ì„ ë¹ ë¥´ê²Œ ê²€ìƒ‰ì—”ì§„ì— ë“±ë¡í•˜ì„¸ìš”.</p>
  </footer>

<script>
  window.onload = () => {
    const loginScreen = document.getElementById("loginScreen");
    const appSection = document.getElementById("appSection");
    const footer = document.getElementById("footer");
    let currentUser = null;
    let hasReloaded = false;

    if (window.netlifyIdentity) {
      netlifyIdentity.on("init", (user) => {
        currentUser = user;
        if (user) {
          loginScreen?.classList.add("hidden");
          appSection?.classList.remove("hidden");
          footer?.classList.remove("hidden");
          try {
            loadStats();
          } catch (err) {
            console.error("âŒ loadStats ì˜¤ë¥˜:", err);
          }
        } else {
          loginScreen?.classList.remove("hidden");
          appSection?.classList.add("hidden");
          footer?.classList.add("hidden");
        }
      });

      netlifyIdentity.on("login", () => {
        if (!hasReloaded) {
          hasReloaded = true;
          location.reload();
        }
      });

      netlifyIdentity.init();
    }

    // ìƒ‰ì¸ í™•ì¸
    document.getElementById("submitForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const urlInput = document.getElementById("blogUrl");
      const blogUrl = urlInput.value.trim();
      if (!blogUrl || !currentUser?.id) return;

      try {
        const res = await fetch("/.netlify/functions/fetchMissingPosts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogUrl, userId: currentUser.id }),
        });

        const data = await res.json();
        const resultBox = document.getElementById("resultBox");
        const resultText = document.getElementById("resultText");

        if (!data || !data.success) {
          resultBox.classList.remove("hidden");

          let errorDetail = "";
          if (data?.detail) {
            const { reason, feed, total, failed, failedList, message, stack } = data.detail;
            if (reason) errorDetail += `ğŸ“Œ ì›ì¸: ${reason}\n`;
            if (feed) errorDetail += `ğŸ“ í”¼ë“œ ì£¼ì†Œ: ${feed}\n`;
            if (typeof total === "number") errorDetail += `ğŸ“„ ìˆ˜ì§‘ëœ ê¸€ ìˆ˜: ${total}, ì‹¤íŒ¨: ${failed}\n`;

            if (failedList?.length) {
              errorDetail += `\nğŸ§¯ ì‹¤íŒ¨ ëª©ë¡ (ì¼ë¶€):\n`;
              failedList.slice(0, 5).forEach(f => {
                errorDetail += `- ${f.url} â†’ G:${f.engines?.google ? "O" : "X"}, B:${f.engines?.bing ? "O" : "X"}, N:${f.engines?.naver ? "O" : "X"}\n`;
              });
            }

            if (message) errorDetail += `\nğŸªµ ë©”ì‹œì§€: ${message}\n`;
            if (stack) errorDetail += `ğŸ§± ìŠ¤íƒ: ${stack.split("\n")[0]}\n`;
          } else {
            // detailì´ ì—†ì„ ë•Œë„ ìµœì†Œí•œ error ë¬¸ìì—´ì€ ë³´ì—¬ì£¼ì
            errorDetail += `ğŸ§ª ì‘ë‹µ ë‚´ìš©: ${JSON.stringify(data, null, 2)}\n`;
          }

          resultText.innerText = `âŒ ì˜¤ë¥˜: ${data?.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}\n${errorDetail}`;
          return;
        }

        document.getElementById("indexSubmitBtn").disabled = false;
        resultBox.classList.remove("hidden");
        resultText.innerText = `âœ… ì´ ${data.total}ê°œ ì¤‘ ${data.registered}ê±´ ë“±ë¡ ìš”ì²­ ì™„ë£Œ`;
        urlInput.value = "";
      } catch (err) {
        document.getElementById("resultBox").classList.remove("hidden");
        document.getElementById("resultText").innerText = `âŒ ìš”ì²­ ì‹¤íŒ¨: ${err.message}`;
      }
    });

    // ìƒ‰ì¸ ë“±ë¡ ìš”ì²­
    document.getElementById("indexSubmitBtn").addEventListener("click", async () => {
      try {
        const res = await fetch("/.netlify/functions/pingPosts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUser?.id }),
        });

        const data = await res.json();
        const resultText = document.getElementById("resultText");
        document.getElementById("resultBox").classList.remove("hidden");

        if (data.success) {
          resultText.innerText = `ğŸ‰ ë“±ë¡ ìš”ì²­ ì™„ë£Œ: ì´ ${data.total}ê±´ ì¤‘ ${data.registered}ê±´ ì„±ê³µ`;
        } else {
          resultText.innerText = `âŒ ë“±ë¡ ìš”ì²­ ì‹¤íŒ¨: ${data?.error || "ì„œë²„ ì˜¤ë¥˜"}`;
        }
      } catch (err) {
        document.getElementById("resultText").innerText = `âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ${err.message}`;
        document.getElementById("resultBox").classList.remove("hidden");
      }
    });

    // íƒ­ ì „í™˜
    document.getElementById("tabSearch").onclick = () => {
      document.getElementById("searchView").classList.remove("hidden");
      document.getElementById("statsView").classList.add("hidden");
    };

    document.getElementById("tabStats").onclick = () => {
      document.getElementById("searchView").classList.add("hidden");
      document.getElementById("statsView").classList.remove("hidden");
      try {
        loadStats();
      } catch (e) {
        console.error("âŒ í†µê³„ ë¡œë”© ì˜¤ë¥˜:", e);
      }
    };

    async function loadStats() {
      const statsBox = document.getElementById("statsContent");
      statsBox.innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      const today = new Date().toISOString().split("T")[0];

      if (!currentUser?.id) {
        statsBox.innerHTML = "âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ";
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/getUserStats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUser.id, date: today }),
        });

        const data = await res.json();
        if (data.error) return statsBox.innerHTML = `âŒ ì˜¤ë¥˜: ${data.error}`;

        const rows = [...data.successList, ...data.failedList].map(item => `
          <li class="mb-1">
            <span class="font-mono text-xs">${item.url}</span><br>
            <span class="text-sm ${item.result === "success" ? "text-green-600" : "text-red-500"}">
              ${item.result === "success" ? "âœ… ì„±ê³µ" : "âŒ ì‹¤íŒ¨"} | 
              G: ${item.engines?.google ? "âœ…" : "âŒ"} / 
              B: ${item.engines?.bing ? "âœ…" : "âŒ"} / 
              N: ${item.engines?.naver ? "âœ…" : "âŒ"}
            </span>
          </li>
        `);

        statsBox.innerHTML = `
          <div class="mb-2">ì´ ìš”ì²­: ${data.total} / ì„±ê³µ: ${data.registered} / ì‹¤íŒ¨: ${data.failed}</div>
          <ul class="text-sm max-h-72 overflow-y-auto pl-4 list-disc">${rows.join("")}</ul>
        `;
      } catch (err) {
        statsBox.innerHTML = `âŒ ìš”ì²­ ì‹¤íŒ¨: ${err.message}`;
      }
    }
  };
</script>
</body>
</html>
<!-- Force cache bust 2025-07-30-03 -->
