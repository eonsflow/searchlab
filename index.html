<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>블로그 색인 검색 등록</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="bg-gradient-to-b from-blue-500 to-blue-700 text-white font-sans">

  <!-- 로그인 안내 -->
  <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center">
    <h1 class="text-3xl font-bold mb-6">🔒 로그인 필요</h1>
    <p class="mb-4 text-lg">이 기능을 사용하려면 먼저 로그인해야 합니다.</p>
    <button onclick="netlifyIdentity.open()" class="bg-white text-blue-800 px-6 py-2 rounded shadow font-semibold">
      로그인 / 회원가입
    </button>
  </div>

  <!-- 앱 본문 -->
  <section id="appSection" class="hidden min-h-screen flex flex-col items-center justify-start px-4 pt-10">
    <div class="flex space-x-4 mb-6">
      <button id="tabSearch" class="px-4 py-2 bg-white text-blue-700 rounded font-semibold hover:bg-gray-200">🔍 색인 등록</button>
      <button id="tabStats" class="px-4 py-2 bg-blue-100 text-blue-800 rounded font-semibold hover:bg-gray-200">📊 통계 보기</button>
    </div>

    <!-- 색인 등록 -->
    <div id="searchView" class="w-full flex flex-col items-center">
      <form id="submitForm" class="w-full max-w-xl flex relative">
        <input 
          type="text" 
          id="blogUrl" 
          placeholder="블로그 주소 입력 (예: myblog.tistory.com)" 
          class="flex-1 h-14 px-4 text-black rounded-l-md focus:outline-none text-lg" 
          required
        />
        <button 
          type="submit" 
          class="bg-white text-blue-700 px-6 rounded-r-md text-lg font-semibold hover:bg-gray-200 transition-colors"
        >
          확인하기
        </button>
      </form>

      <button 
        id="indexSubmitBtn" 
        class="mt-4 bg-green-500 text-white px-6 py-2 rounded font-semibold hover:bg-green-600 transition-colors disabled:opacity-50"
        disabled
      >
        색인 등록 요청
      </button>

      <div id="resultBox" class="hidden mt-10 bg-white text-black rounded-md p-6 shadow-md w-full max-w-xl">
        <h2 class="text-xl font-bold mb-2">✅ 결과</h2>
        <p id="resultText" class="text-gray-800 whitespace-pre-line">잠시만 기다려주세요...</p>
      </div>
    </div>

    <!-- 통계 -->
    <div id="statsView" class="hidden w-full max-w-2xl bg-white text-black rounded-md shadow-md p-6">
      <h2 class="text-2xl font-bold mb-4">📊 오늘 통계</h2>
      <div id="statsContent">불러오는 중...</div>
    </div>
  </section>

  <footer id="footer" class="hidden bg-white text-gray-800 text-center py-10">
    <p class="text-lg font-semibold">누락된 글을 빠르게 검색엔진에 등록하세요.</p>
  </footer>

<script>
  window.onload = () => {
    const loginScreen = document.getElementById("loginScreen");
    const appSection = document.getElementById("appSection");
    const footer = document.getElementById("footer");
    let currentUser = null;
    let hasReloaded = false;

    if (window.netlifyIdentity) {
      netlifyIdentity.on("init", (user) => {
        currentUser = user;
        if (user) {
          loginScreen?.classList.add("hidden");
          appSection?.classList.remove("hidden");
          footer?.classList.remove("hidden");
          try {
            loadStats();
          } catch (err) {
            console.error("❌ loadStats 오류:", err);
          }
        } else {
          loginScreen?.classList.remove("hidden");
          appSection?.classList.add("hidden");
          footer?.classList.add("hidden");
        }
      });

      netlifyIdentity.on("login", () => {
        if (!hasReloaded) {
          hasReloaded = true;
          location.reload();
        }
      });

      netlifyIdentity.init();
    }

    // 색인 확인
    document.getElementById("submitForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const urlInput = document.getElementById("blogUrl");
      const blogUrl = urlInput.value.trim();
      if (!blogUrl || !currentUser?.id) return;

      try {
        const res = await fetch("/.netlify/functions/fetchMissingPosts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogUrl, userId: currentUser.id }),
        });

        const data = await res.json();
        const resultBox = document.getElementById("resultBox");
        const resultText = document.getElementById("resultText");

        if (!data || !data.success) {
          resultBox.classList.remove("hidden");

          let errorDetail = "";
          if (data?.detail) {
            const { reason, feed, total, failed, failedList, message, stack } = data.detail;
            if (reason) errorDetail += `📌 원인: ${reason}\n`;
            if (feed) errorDetail += `📎 피드 주소: ${feed}\n`;
            if (typeof total === "number") errorDetail += `📄 수집된 글 수: ${total}, 실패: ${failed}\n`;

            if (failedList?.length) {
              errorDetail += `\n🧯 실패 목록 (일부):\n`;
              failedList.slice(0, 5).forEach(f => {
                errorDetail += `- ${f.url} → G:${f.engines?.google ? "O" : "X"}, B:${f.engines?.bing ? "O" : "X"}, N:${f.engines?.naver ? "O" : "X"}\n`;
              });
            }

            if (message) errorDetail += `\n🪵 메시지: ${message}\n`;
            if (stack) errorDetail += `🧱 스택: ${stack.split("\n")[0]}\n`;
          } else {
            // detail이 없을 때도 최소한 error 문자열은 보여주자
            errorDetail += `🧪 응답 내용: ${JSON.stringify(data, null, 2)}\n`;
          }

          resultText.innerText = `❌ 오류: ${data?.error || "알 수 없는 오류"}\n${errorDetail}`;
          return;
        }

        document.getElementById("indexSubmitBtn").disabled = false;
        resultBox.classList.remove("hidden");
        resultText.innerText = `✅ 총 ${data.total}개 중 ${data.registered}건 등록 요청 완료`;
        urlInput.value = "";
      } catch (err) {
        document.getElementById("resultBox").classList.remove("hidden");
        document.getElementById("resultText").innerText = `❌ 요청 실패: ${err.message}`;
      }
    });

    // 색인 등록 요청
    document.getElementById("indexSubmitBtn").addEventListener("click", async () => {
      try {
        const res = await fetch("/.netlify/functions/pingPosts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUser?.id }),
        });

        const data = await res.json();
        const resultText = document.getElementById("resultText");
        document.getElementById("resultBox").classList.remove("hidden");

        if (data.success) {
          resultText.innerText = `🎉 등록 요청 완료: 총 ${data.total}건 중 ${data.registered}건 성공`;
        } else {
          resultText.innerText = `❌ 등록 요청 실패: ${data?.error || "서버 오류"}`;
        }
      } catch (err) {
        document.getElementById("resultText").innerText = `❌ 등록 중 오류: ${err.message}`;
        document.getElementById("resultBox").classList.remove("hidden");
      }
    });

    // 탭 전환
    document.getElementById("tabSearch").onclick = () => {
      document.getElementById("searchView").classList.remove("hidden");
      document.getElementById("statsView").classList.add("hidden");
    };

    document.getElementById("tabStats").onclick = () => {
      document.getElementById("searchView").classList.add("hidden");
      document.getElementById("statsView").classList.remove("hidden");
      try {
        loadStats();
      } catch (e) {
        console.error("❌ 통계 로딩 오류:", e);
      }
    };

    async function loadStats() {
      const statsBox = document.getElementById("statsContent");
      statsBox.innerHTML = "불러오는 중...";
      const today = new Date().toISOString().split("T")[0];

      if (!currentUser?.id) {
        statsBox.innerHTML = "❌ 사용자 정보 없음";
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/getUserStats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUser.id, date: today }),
        });

        const data = await res.json();
        if (data.error) return statsBox.innerHTML = `❌ 오류: ${data.error}`;

        const rows = [...data.successList, ...data.failedList].map(item => `
          <li class="mb-1">
            <span class="font-mono text-xs">${item.url}</span><br>
            <span class="text-sm ${item.result === "success" ? "text-green-600" : "text-red-500"}">
              ${item.result === "success" ? "✅ 성공" : "❌ 실패"} | 
              G: ${item.engines?.google ? "✅" : "❌"} / 
              B: ${item.engines?.bing ? "✅" : "❌"} / 
              N: ${item.engines?.naver ? "✅" : "❌"}
            </span>
          </li>
        `);

        statsBox.innerHTML = `
          <div class="mb-2">총 요청: ${data.total} / 성공: ${data.registered} / 실패: ${data.failed}</div>
          <ul class="text-sm max-h-72 overflow-y-auto pl-4 list-disc">${rows.join("")}</ul>
        `;
      } catch (err) {
        statsBox.innerHTML = `❌ 요청 실패: ${err.message}`;
      }
    }
  };
</script>
</body>
</html>
<!-- Force cache bust 2025-07-30-03 -->
